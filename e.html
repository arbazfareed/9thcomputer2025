<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Marks Tracker</title>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;
    
    // Lucide React Icons as simple SVG components
    const Download = ({ size = 20 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/>
      </svg>
    );

    const Plus = ({ size = 20 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M12 5v14M5 12h14"/>
      </svg>
    );

    const Trash2 = ({ size = 20 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
      </svg>
    );

    const FileText = ({ size = 20 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
        <path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/>
      </svg>
    );

    const Settings = ({ size = 20 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <circle cx="12" cy="12" r="3"/>
        <path d="M12 1v6m0 6v6M5.64 5.64l4.24 4.24m4.24 4.24l4.24 4.24M1 12h6m6 0h6M5.64 18.36l4.24-4.24m4.24-4.24l4.24-4.24"/>
      </svg>
    );

    const Upload = ({ size = 20 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/>
      </svg>
    );

    const Award = ({ size = 20, className = "" }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}>
        <circle cx="12" cy="8" r="7"/>
        <path d="M8.21 13.89L7 23l5-3 5 3-1.21-9.11"/>
      </svg>
    );

    const Eye = ({ size = 20 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
        <circle cx="12" cy="12" r="3"/>
      </svg>
    );

    const EyeOff = ({ size = 20 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
        <line x1="1" y1="1" x2="23" y2="23"/>
      </svg>
    );

    const Spreadsheet = ({ size = 20 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
        <line x1="3" y1="9" x2="21" y2="9"/>
        <line x1="3" y1="15" x2="21" y2="15"/>
        <line x1="9" y1="9" x2="9" y2="21"/>
        <line x1="15" y1="9" x2="15" y2="21"/>
      </svg>
    );

    const Edit = ({ size = 20 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
      </svg>
    );

    const FilePdf = ({ size = 20 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
        <polyline points="14 2 14 8 20 8"/>
        <path d="M10 9H8"/>
        <path d="M16 13H8"/>
        <path d="M16 17H8"/>
        <path d="M10 21H8"/>
      </svg>
    );

    const StudentMarksTracker = () => {
      // Load data from localStorage on component mount
      const loadSavedData = () => {
        try {
          const savedData = localStorage.getItem('studentMarksData');
          if (savedData) {
            const data = JSON.parse(savedData);
            console.log('Loaded data:', data);
            return data;
          }
        } catch (error) {
          console.error('Error loading saved data:', error);
        }
        return null;
      };

      const savedData = loadSavedData();

      const [subjectName, setSubjectName] = useState(savedData?.subjectName || 'Computer Science');
      const [className, setClassName] = useState(savedData?.className || 'Class 9');
      const [students, setStudents] = useState(savedData?.students || [
        { id: 1, name: 'Kamran', marks: { 1: { obj: 10.5, total: 40 }, 2: { obj: 11, total: 40 } } },
        { id: 2, name: 'Waqas', marks: { 1: { obj: 12, total: 40 }, 2: { obj: 9, total: 40 } } },
        { id: 3, name: 'Shahryar', marks: { 1: { obj: 9, total: 40 }, 2: { obj: 17, total: 40 } } },
        { id: 4, name: 'Mehtab', marks: { 1: { obj: 'Absent', total: 40 }, 2: { obj: 9.5, total: 40 } } },
        { id: 5, name: 'Saghar', marks: { 1: { obj: 20, total: 40 }, 2: { obj: 23, total: 40 } } },
      ]);
      
      const [tests, setTests] = useState(savedData?.tests || [
        { id: 1, name: 'Test #1', objMax: 40, totalMax: 40, date: '2025-10-01', completed: true },
        { id: 2, name: 'Test #2', objMax: 40, totalMax: 40, date: '2025-10-15', completed: true }
      ]);

      const [gradeSystem, setGradeSystem] = useState(savedData?.gradeSystem || [
        { min: 90, grade: 'A+', remarks: 'Outstanding' },
        { min: 80, grade: 'A', remarks: 'Excellent' },
        { min: 70, grade: 'B', remarks: 'Very Good' },
        { min: 60, grade: 'C', remarks: 'Good' },
        { min: 50, grade: 'D', remarks: 'Satisfactory' },
        { min: 40, grade: 'E', remarks: 'Pass' },
        { min: 0, grade: 'F', remarks: 'Fail' }
      ]);

      const [newStudent, setNewStudent] = useState('');
      const [selectedStudent, setSelectedStudent] = useState(null);
      const [showSettings, setShowSettings] = useState(false);
      const [showGradeSettings, setShowGradeSettings] = useState(false);
      const [hideIncompleteTests, setHideIncompleteTests] = useState(false);
      const [editingSubject, setEditingSubject] = useState(false);
      const [editingClassName, setEditingClassName] = useState(false);
      const [editingTestTotal, setEditingTestTotal] = useState(null);
      const [autoSaveEnabled, setAutoSaveEnabled] = useState(true);
      const [lastSaved, setLastSaved] = useState(savedData?.lastSaved || null);
      const [dataStatus, setDataStatus] = useState('');

      // Auto-save to localStorage whenever data changes
      useEffect(() => {
        const saveData = () => {
          const dataToSave = {
            subjectName,
            className,
            students,
            tests,
            gradeSystem,
            lastSaved: new Date().toLocaleTimeString()
          };
          
          try {
            localStorage.setItem('studentMarksData', JSON.stringify(dataToSave));
            setLastSaved(new Date().toLocaleTimeString());
            setDataStatus('‚úÖ Data saved successfully!');
            setTimeout(() => setDataStatus(''), 3000);
          } catch (error) {
            console.error('Error saving data:', error);
            setDataStatus('‚ùå Error saving data');
            setTimeout(() => setDataStatus(''), 3000);
          }
        };

        if (autoSaveEnabled) {
          saveData();
        }
      }, [autoSaveEnabled, students, tests, subjectName, className, gradeSystem]);

      const getGrade = (percentage) => {
        const p = parseFloat(percentage);
        for (let grade of gradeSystem) {
          if (p >= grade.min) return grade;
        }
        return gradeSystem[gradeSystem.length - 1];
      };

      const calculatePercentage = (studentId, includeIncomplete = false) => {
        const student = students.find(s => s.id === studentId);
        if (!student) return 0;
        
        let totalMarks = 0;
        let totalMax = 0;
        
        tests.forEach(test => {
          if (!includeIncomplete && !test.completed) return;
          
          const mark = student.marks[test.id];
          if (mark && mark.obj !== 'Absent' && mark.obj !== '' && !isNaN(parseFloat(mark.obj))) {
            totalMarks += parseFloat(mark.obj) || 0;
            totalMax += test.objMax;
          }
        });
        
        return totalMax > 0 ? ((totalMarks / totalMax) * 100).toFixed(2) : 0;
      };

      const getRankings = () => {
        const studentsWithPercentage = students.map(s => ({
          ...s,
          percentage: parseFloat(calculatePercentage(s.id))
        }));
        
        return studentsWithPercentage.sort((a, b) => b.percentage - a.percentage);
      };

      const getTestRankings = (testId) => {
        const studentsWithMarks = students.map(s => {
          const mark = s.marks[testId];
          const obtainedMarks = mark && mark.obj !== 'Absent' && mark.obj !== '' ? parseFloat(mark.obj) || 0 : 0;
          return { ...s, testMarks: obtainedMarks, isAbsent: mark && mark.obj === 'Absent' };
        });
        
        return studentsWithMarks.sort((a, b) => b.testMarks - a.testMarks);
      };

      const addStudent = () => {
        if (newStudent.trim()) {
          const newId = Math.max(...students.map(s => s.id), 0) + 1;
          const marks = {};
          tests.forEach(test => {
            marks[test.id] = { obj: '', total: test.totalMax };
          });
          const updatedStudents = [...students, { id: newId, name: newStudent.trim(), marks }];
          setStudents(updatedStudents);
          setNewStudent('');
          setDataStatus('‚úÖ Student added successfully!');
          setTimeout(() => setDataStatus(''), 3000);
        }
      };

      const deleteStudent = (id) => {
        if (confirm('Delete this student?')) {
          setStudents(students.filter(s => s.id !== id));
          setDataStatus('‚úÖ Student deleted successfully!');
          setTimeout(() => setDataStatus(''), 3000);
        }
      };

      const addTest = () => {
        const newId = Math.max(...tests.map(t => t.id), 0) + 1;
        const newTest = { 
          id: newId, 
          name: `Test #${newId}`, 
          objMax: 40, 
          totalMax: 40, 
          date: new Date().toISOString().split('T')[0],
          completed: false 
        };
        const updatedTests = [...tests, newTest];
        setTests(updatedTests);
        
        const updatedStudents = students.map(s => ({
          ...s,
          marks: { ...s.marks, [newId]: { obj: '', total: 40 } }
        }));
        setStudents(updatedStudents);
        setDataStatus('‚úÖ Test added successfully!');
        setTimeout(() => setDataStatus(''), 3000);
      };

      const deleteTest = (testId) => {
        if (confirm('Delete this test?')) {
          setTests(tests.filter(t => t.id !== testId));
          setStudents(students.map(s => {
            const newMarks = { ...s.marks };
            delete newMarks[testId];
            return { ...s, marks: newMarks };
          }));
          setDataStatus('‚úÖ Test deleted successfully!');
          setTimeout(() => setDataStatus(''), 3000);
        }
      };

      const updateTest = (testId, field, value) => {
        const updatedTests = tests.map(t => t.id === testId ? { ...t, [field]: value } : t);
        setTests(updatedTests);
        
        // If updating totalMax, update all student marks for this test
        if (field === 'totalMax') {
          const updatedStudents = students.map(s => ({
            ...s,
            marks: {
              ...s.marks,
              [testId]: { ...s.marks[testId], total: parseInt(value) || 0 }
            }
          }));
          setStudents(updatedStudents);
        }
      };

      const toggleTestCompletion = (testId) => {
        setTests(tests.map(t => t.id === testId ? { ...t, completed: !t.completed } : t));
      };

      const updateMarks = (studentId, testId, field, value) => {
        const updatedStudents = students.map(s => {
          if (s.id === studentId) {
            const updatedMarks = {
              ...s.marks,
              [testId]: { 
                ...s.marks[testId], 
                [field]: field === 'obj' ? value : parseInt(value) || 0 
              }
            };
            return {
              ...s,
              marks: updatedMarks
            };
          }
          return s;
        });
        setStudents(updatedStudents);
      };

      const updateStudentName = (studentId, newName) => {
        const updatedStudents = students.map(s => 
          s.id === studentId ? { ...s, name: newName } : s
        );
        setStudents(updatedStudents);
      };

      const exportToExcel = (type = 'all') => {
        try {
          // Create a new workbook
          const wb = XLSX.utils.book_new();
          
          // Prepare data for the sheet
          const visibleTests = hideIncompleteTests ? tests.filter(t => t.completed) : tests;
          const rankings = getRankings();
          
          // Create header row
          const headerRow = ['Name'];
          visibleTests.forEach(test => {
            headerRow.push(`${test.name} Obtained`);
            headerRow.push(`${test.name} Total`);
            headerRow.push(`${test.name} Percentage`);
          });
          headerRow.push('Overall %', 'Grade', 'Remarks', 'Rank');
          
          // Create data rows
          const dataRows = [];
          
          if (type === 'all') {
            students.forEach(student => {
              const row = [student.name];
              visibleTests.forEach(test => {
                const mark = student.marks[test.id] || { obj: '', total: test.totalMax };
                const perc = mark.obj !== 'Absent' && mark.obj !== '' && !isNaN(parseFloat(mark.obj))
                  ? ((parseFloat(mark.obj) / test.objMax) * 100).toFixed(1)
                  : 'N/A';
                row.push(mark.obj, mark.total, perc + '%');
              });
              const overallPerc = calculatePercentage(student.id);
              const grade = getGrade(overallPerc);
              const rank = rankings.findIndex(s => s.id === student.id) + 1;
              row.push(overallPerc + '%', grade.grade, grade.remarks, rank);
              dataRows.push(row);
            });
          } else if (type === 'student' && selectedStudent) {
            const student = students.find(s => s.id === selectedStudent);
            const row = [student.name];
            visibleTests.forEach(test => {
              const mark = student.marks[test.id] || { obj: '', total: test.totalMax };
              const perc = mark.obj !== 'Absent' && mark.obj !== '' && !isNaN(parseFloat(mark.obj))
                ? ((parseFloat(mark.obj) / test.objMax) * 100).toFixed(1)
                : 'N/A';
              row.push(mark.obj, mark.total, perc + '%');
            });
            const overallPerc = calculatePercentage(student.id);
            const grade = getGrade(overallPerc);
            const rank = rankings.findIndex(s => s.id === student.id) + 1;
            row.push(overallPerc + '%', grade.grade, grade.remarks, rank);
            dataRows.push(row);
          }
          
          // Combine header and data
          const wsData = [headerRow, ...dataRows];
          
          // Create worksheet
          const ws = XLSX.utils.aoa_to_sheet(wsData);
          
          // Add worksheet to workbook
          XLSX.utils.book_append_sheet(wb, ws, 'Student Marks');
          
          // Generate Excel file and trigger download
          XLSX.writeFile(wb, type === 'all' 
            ? `${className}_${subjectName}_AllStudents.xlsx`
            : `${className}_${subjectName}_${students.find(s => s.id === selectedStudent)?.name}.xlsx`);
            
          setDataStatus('‚úÖ Excel exported successfully!');
          setTimeout(() => setDataStatus(''), 3000);
        } catch (error) {
          console.error('Error exporting to Excel:', error);
          setDataStatus('‚ùå Error exporting to Excel');
          setTimeout(() => setDataStatus(''), 3000);
        }
      };

      // NEW: Export to PDF with full test details
      const exportToPDF = (type = 'all', testId = null) => {
        try {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();
          
          // Add title
          doc.setFontSize(20);
          doc.text(`${className} - ${subjectName}`, 105, 15, { align: 'center' });
          
          if (type === 'all') {
            // Class summary
            doc.setFontSize(12);
            doc.text(`Total Students: ${students.length}`, 20, 30);
            doc.text(`Total Tests: ${tests.length}`, 20, 40);
            doc.text(`Completed Tests: ${tests.filter(t => t.completed).length}`, 20, 50);
            
            const avgPercentage = students.length > 0 
              ? (students.reduce((sum, s) => sum + parseFloat(calculatePercentage(s.id)), 0) / students.length).toFixed(1)
              : 0;
            doc.text(`Average Class Percentage: ${avgPercentage}%`, 20, 60);
            
            // Student table with full test details
            let yPosition = 80;
            const rankings = getRankings();
            
            // Table header
            doc.setFillColor(100, 100, 200);
            doc.rect(20, yPosition, 170, 10, 'F');
            doc.setTextColor(255, 255, 255);
            doc.text('Rank', 25, yPosition + 7);
            doc.text('Name', 45, yPosition + 7);
            
            // Add test columns
            let xPosition = 80;
            const visibleTests = hideIncompleteTests ? tests.filter(t => t.completed) : tests;
            
            // Adjust column widths based on number of tests
            const colWidth = Math.min(20, 160 / visibleTests.length);
            
            visibleTests.forEach(test => {
              doc.text(test.name, xPosition, yPosition + 7);
              xPosition += colWidth;
            });
            
            doc.text('Overall %', xPosition, yPosition + 7);
            doc.text('Grade', xPosition + 20, yPosition + 7);
            doc.text('Remarks', xPosition + 35, yPosition + 7);
            
            yPosition += 10;
            doc.setTextColor(0, 0, 0);
            
            // Student rows
            rankings.forEach((student, index) => {
              if (yPosition > 270) {
                doc.addPage();
                yPosition = 20;
                
                // Add header again on new page
                doc.setFillColor(100, 100, 200);
                doc.rect(20, yPosition, 170, 10, 'F');
                doc.setTextColor(255, 255, 255);
                doc.text('Rank', 25, yPosition + 7);
                doc.text('Name', 45, yPosition + 7);
                
                xPosition = 80;
                visibleTests.forEach(test => {
                  doc.text(test.name, xPosition, yPosition + 7);
                  xPosition += colWidth;
                });
                
                doc.text('Overall %', xPosition, yPosition + 7);
                doc.text('Grade', xPosition + 20, yPosition + 7);
                doc.text('Remarks', xPosition + 35, yPosition + 7);
                
                yPosition += 10;
                doc.setTextColor(0, 0, 0);
              }
              
              const grade = getGrade(student.percentage);
              doc.text((index + 1).toString(), 25, yPosition + 7);
              doc.text(student.name, 45, yPosition + 7);
              
              // Add test marks
              xPosition = 80;
              visibleTests.forEach(test => {
                const mark = student.marks[test.id] || { obj: '', total: test.totalMax };
                const percentage = mark.obj !== 'Absent' && mark.obj !== '' && !isNaN(parseFloat(mark.obj))
                  ? ((parseFloat(mark.obj) / test.objMax) * 100).toFixed(1)
                  : 'N/A';
                
                doc.text(mark.obj === 'Absent' ? 'Abs' : mark.obj.toString(), xPosition, yPosition + 7);
                xPosition += colWidth;
              });
              
              doc.text(`${student.percentage}%`, xPosition, yPosition + 7);
              doc.text(grade.grade, xPosition + 20, yPosition + 7);
              doc.text(grade.remarks, xPosition + 35, yPosition + 7);
              
              yPosition += 10;
            });
          } else if (type === 'student' && selectedStudent) {
            const student = students.find(s => s.id === selectedStudent);
            const rankings = getRankings();
            const rank = rankings.findIndex(s => s.id === student.id) + 1;
            const overallPerc = calculatePercentage(student.id);
            const grade = getGrade(overallPerc);
            
            // Student header
            doc.setFontSize(16);
            doc.text(`Student Report: ${student.name}`, 105, 30, { align: 'center' });
            
            doc.setFontSize(12);
            doc.text(`Class: ${className}`, 20, 50);
            doc.text(`Subject: ${subjectName}`, 20, 60);
            doc.text(`Overall Percentage: ${overallPerc}%`, 20, 70);
            doc.text(`Grade: ${grade.grade}`, 20, 80);
            doc.text(`Remarks: ${grade.remarks}`, 20, 90);
            doc.text(`Class Rank: ${rank}/${students.length}`, 20, 100);
            
            // Test details
            let yPosition = 120;
            doc.text('Test Performance:', 20, yPosition);
            yPosition += 10;
            
            tests.filter(t => t.completed).forEach(test => {
              if (yPosition > 270) {
                doc.addPage();
                yPosition = 20;
              }
              
              const mark = student.marks[test.id] || { obj: '', total: test.totalMax };
              const testRankings = getTestRankings(test.id);
              const testRank = testRankings.findIndex(s => s.id === student.id) + 1;
              const percentage = mark.obj !== 'Absent' && mark.obj !== '' && !isNaN(parseFloat(mark.obj))
                ? ((parseFloat(mark.obj) / test.objMax) * 100).toFixed(1)
                : 'N/A';
              
              doc.text(`${test.name} (${test.date}):`, 25, yPosition);
              doc.text(`Marks: ${mark.obj === 'Absent' ? 'Absent' : mark.obj}/${test.totalMax}`, 40, yPosition + 7);
              doc.text(`Percentage: ${percentage}%`, 40, yPosition + 14);
              doc.text(`Test Rank: ${mark.obj === 'Absent' ? 'N/A' : `${testRank}/${students.length}`}`, 40, yPosition + 21);
              
              yPosition += 28;
            });
          } else if (type === 'test' && testId) {
            const test = tests.find(t => t.id === testId);
            if (!test) return;
            
            doc.setFontSize(16);
            doc.text(`Test Report: ${test.name}`, 105, 30, { align: 'center' });
            doc.setFontSize(12);
            doc.text(`Date: ${test.date}`, 105, 40, { align: 'center' });
            
            // Test statistics
            const testRankings = getTestRankings(testId);
            const totalStudents = students.length;
            const presentStudents = testRankings.filter(s => !s.isAbsent).length;
            const avgMarks = presentStudents > 0 
              ? (testRankings.filter(s => !s.isAbsent).reduce((sum, s) => sum + s.testMarks, 0) / presentStudents).toFixed(1)
              : 0;
            
            doc.text(`Total Students: ${totalStudents}`, 20, 60);
            doc.text(`Present Students: ${presentStudents}`, 20, 70);
            doc.text(`Absent Students: ${totalStudents - presentStudents}`, 20, 80);
            doc.text(`Average Marks: ${avgMarks}/${test.objMax}`, 20, 90);
            
            // Student rankings for this test
            let yPosition = 110;
            doc.setFillColor(100, 100, 200);
            doc.rect(20, yPosition, 170, 10, 'F');
            doc.setTextColor(255, 255, 255);
            doc.text('Rank', 25, yPosition + 7);
            doc.text('Name', 45, yPosition + 7);
            doc.text('Marks', 100, yPosition + 7);
            doc.text('Percentage', 130, yPosition + 7);
            doc.text('Grade', 160, yPosition + 7);
            
            yPosition += 10;
            doc.setTextColor(0, 0, 0);
            
            testRankings.forEach((student, index) => {
              if (yPosition > 270) {
                doc.addPage();
                yPosition = 20;
                
                // Add header again on new page
                doc.setFillColor(100, 100, 200);
                doc.rect(20, yPosition, 170, 10, 'F');
                doc.setTextColor(255, 255, 255);
                doc.text('Rank', 25, yPosition + 7);
                doc.text('Name', 45, yPosition + 7);
                doc.text('Marks', 100, yPosition + 7);
                doc.text('Percentage', 130, yPosition + 7);
                doc.text('Grade', 160, yPosition + 7);
                
                yPosition += 10;
                doc.setTextColor(0, 0, 0);
              }
              
              const percentage = student.isAbsent ? 'N/A' : ((student.testMarks / test.objMax) * 100).toFixed(1);
              const grade = student.isAbsent ? { grade: 'N/A' } : getGrade(percentage);
              
              doc.text((index + 1).toString(), 25, yPosition + 7);
              doc.text(student.name, 45, yPosition + 7);
              doc.text(student.isAbsent ? 'Absent' : student.testMarks.toString(), 100, yPosition + 7);
              doc.text(student.isAbsent ? 'N/A' : percentage + '%', 130, yPosition + 7);
              doc.text(grade.grade, 160, yPosition + 7);
              
              yPosition += 10;
            });
          }
          
          // Save the PDF
          let fileName = '';
          if (type === 'all') {
            fileName = `${className}_${subjectName}_FullReport.pdf`;
          } else if (type === 'student' && selectedStudent) {
            fileName = `${className}_${subjectName}_${students.find(s => s.id === selectedStudent)?.name}_Report.pdf`;
          } else if (type === 'test' && testId) {
            const test = tests.find(t => t.id === testId);
            fileName = `${className}_${subjectName}_${test?.name}_Report.pdf`;
          }
          
          doc.save(fileName);
          setDataStatus('‚úÖ PDF exported successfully!');
          setTimeout(() => setDataStatus(''), 3000);
        } catch (error) {
          console.error('Error exporting to PDF:', error);
          setDataStatus('‚ùå Error exporting to PDF');
          setTimeout(() => setDataStatus(''), 3000);
        }
      };

      // NEW: Export all test PDFs
      const exportAllTestPDFs = () => {
        tests.filter(t => t.completed).forEach((test, index) => {
          setTimeout(() => {
            exportToPDF('test', test.id);
          }, index * 500);
        });
        setDataStatus('‚úÖ All test PDFs exported successfully!');
        setTimeout(() => setDataStatus(''), 3000);
      };

      const importFromExcel = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            
            // Get the first worksheet
            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            
            if (jsonData.length < 2) {
              alert('The Excel file does not contain enough data.');
              return;
            }
            
            // Parse header row to identify tests
            const headerRow = jsonData[0];
            const testHeaders = [];
            
            for (let i = 1; i < headerRow.length; i += 3) {
              if (i + 2 < headerRow.length && headerRow[i]) {
                const testName = headerRow[i].replace(' Obtained', '').trim();
                testHeaders.push({
                  name: testName,
                  obtainedIndex: i,
                  totalIndex: i + 1,
                  percentageIndex: i + 2
                });
              }
            }
            
            // Create new tests if needed
            const newTests = [...tests];
            testHeaders.forEach((header, index) => {
              const existingTest = newTests.find(t => t.name === header.name);
              if (!existingTest) {
                const newId = Math.max(...newTests.map(t => t.id), 0) + 1;
                newTests.push({
                  id: newId,
                  name: header.name,
                  objMax: 40,
                  totalMax: 40,
                  date: new Date().toISOString().split('T')[0],
                  completed: true
                });
              }
            });
            
            // Update students with imported data
            const newStudents = [];
            
            for (let i = 1; i < jsonData.length; i++) {
              const row = jsonData[i];
              if (row.length === 0) continue;
              
              const studentName = row[0];
              if (!studentName) continue;
              
              const marks = {};
              testHeaders.forEach((header, index) => {
                const testId = newTests.find(t => t.name === header.name)?.id || index + 1;
                marks[testId] = {
                  obj: row[header.obtainedIndex] || '',
                  total: row[header.totalIndex] || newTests.find(t => t.id === testId)?.totalMax || 40
                };
              });
              
              // Check if student already exists
              const existingStudent = students.find(s => s.name === studentName);
              if (existingStudent) {
                // Update existing student
                newStudents.push({
                  ...existingStudent,
                  marks: { ...existingStudent.marks, ...marks }
                });
              } else {
                // Create new student
                const newId = Math.max(...students.map(s => s.id), 0) + 1;
                newStudents.push({
                  id: newId,
                  name: studentName,
                  marks
                });
              }
            }
            
            // Update state with imported data
            setTests(newTests);
            setStudents(newStudents);
            setDataStatus('‚úÖ Excel data imported successfully!');
            setTimeout(() => setDataStatus(''), 3000);
          } catch (error) {
            console.error('Error importing Excel file:', error);
            setDataStatus('‚ùå Error importing Excel file');
            setTimeout(() => setDataStatus(''), 3000);
          }
        };
        reader.readAsArrayBuffer(file);
      };

      const generateIndividualReport = (student) => {
        const rankings = getRankings();
        const rank = rankings.findIndex(s => s.id === student.id) + 1;
        const overallPerc = calculatePercentage(student.id);
        const grade = getGrade(overallPerc);
        
        let report = `üìä STUDENT REPORT CARD\n`;
        report += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
        report += `üéì ${className}\n`;
        report += `üìö Subject: ${subjectName}\n`;
        report += `üë§ Student: ${student.name}\n`;
        report += `üìÖ Date: ${new Date().toLocaleDateString()}\n\n`;
        report += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
        report += `üìù TEST PERFORMANCE:\n`;
        report += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
        
        const completedTests = tests.filter(t => t.completed);
        completedTests.forEach(test => {
          const mark = student.marks[test.id] || { obj: '', total: test.totalMax };
          const testRankings = getTestRankings(test.id);
          const testRank = testRankings.findIndex(s => s.id === student.id) + 1;
          const percentage = mark.obj !== 'Absent' && mark.obj !== '' && !isNaN(parseFloat(mark.obj))
            ? ((parseFloat(mark.obj) / test.objMax) * 100).toFixed(1)
            : 'N/A';
          
          report += `${test.name} (${test.date}):\n`;
          report += `  Marks: ${mark.obj === 'Absent' ? 'Absent' : mark.obj}/${test.totalMax}\n`;
          report += `  Percentage: ${percentage}%\n`;
          report += `  Test Rank: ${mark.obj === 'Absent' ? 'N/A' : `${testRank}/${students.length}`}\n\n`;
        });
        
        report += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
        report += `üìà OVERALL SUMMARY:\n`;
        report += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
        report += `Total Percentage: ${overallPerc}%\n`;
        report += `Grade: ${grade.grade}\n`;
        report += `Remarks: ${grade.remarks}\n`;
        report += `Class Rank: ${rank}/${students.length}\n\n`;
        report += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
        
        return report;
      };

      // NEW: Generate text report for a specific test
      const generateTestReport = (testId) => {
        const test = tests.find(t => t.id === testId);
        if (!test) return '';
        
        const testRankings = getTestRankings(testId);
        const totalStudents = students.length;
        const presentStudents = testRankings.filter(s => !s.isAbsent).length;
        const avgMarks = presentStudents > 0 
          ? (testRankings.filter(s => !s.isAbsent).reduce((sum, s) => sum + s.testMarks, 0) / presentStudents).toFixed(1)
          : 0;
        
        let report = `üìä TEST REPORT\n`;
        report += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
        report += `üéì ${className}\n`;
        report += `üìö Subject: ${subjectName}\n`;
        report += `üìù Test: ${test.name}\n`;
        report += `üìÖ Date: ${test.date}\n\n`;
        report += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
        report += `üìà TEST STATISTICS:\n`;
        report += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
        report += `Total Students: ${totalStudents}\n`;
        report += `Present Students: ${presentStudents}\n`;
        report += `Absent Students: ${totalStudents - presentStudents}\n`;
        report += `Average Marks: ${avgMarks}/${test.objMax}\n\n`;
        report += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
        report += `üèÜ STUDENT RANKINGS:\n`;
        report += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
        
        testRankings.forEach((student, index) => {
          const percentage = student.isAbsent ? 'N/A' : ((student.testMarks / test.objMax) * 100).toFixed(1);
          const grade = student.isAbsent ? 'N/A' : getGrade(percentage).grade;
          
          report += `${index + 1}. ${student.name}\n`;
          report += `   Marks: ${student.isAbsent ? 'Absent' : student.testMarks}/${test.totalMax}\n`;
          report += `   Percentage: ${percentage}%\n`;
          report += `   Grade: ${grade}\n\n`;
        });
        
        return report;
      };

      // NEW: Generate class list in text format
     // NEW: Generate clean class list in text format (without test details)
// NEW: Generate class list with test details in text format
const generateClassList = () => {
  const rankings = getRankings();
  const visibleTests = hideIncompleteTests ? tests.filter(t => t.completed) : tests;
  
  let report = `üë®‚Äçüéì CLASS LIST\n`;
  report += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
  report += `üéì ${className}\n`;
  report += `üìö Subject: ${subjectName}\n`;
  report += `üìÖ Date: ${new Date().toLocaleDateString()}\n`;
  report += `üë• Total Students: ${students.length}\n`;
  report += `üìù Total Tests: ${visibleTests.length}\n\n`;
  
  // Add test summary
  report += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
  report += `üìã TEST SUMMARY:\n`;
  report += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
  
  visibleTests.forEach(test => {
    report += `${test.name} (${test.date}): ${test.objMax} marks\n`;
  });
  
  report += `\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
  report += `üèÜ STUDENT RANKINGS WITH TEST DETAILS:\n`;
  report += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
  
  rankings.forEach((student, index) => {
    const grade = getGrade(student.percentage);
    
    report += `${index + 1}. ${student.name}\n`;
    report += `   üìä Overall: ${student.percentage}% | ${grade.grade} | ${grade.remarks}\n`;
    
    // Add test details for this student
    visibleTests.forEach(test => {
      const mark = student.marks[test.id] || { obj: '', total: test.totalMax };
      const percentage = mark.obj !== 'Absent' && mark.obj !== '' && !isNaN(parseFloat(mark.obj))
        ? ((parseFloat(mark.obj) / test.objMax) * 100).toFixed(1)
        : 'N/A';
      
      report += `   üìù ${test.name}: ${mark.obj === 'Absent' ? 'Absent' : mark.obj}/${test.totalMax} (${percentage}%)\n`;
    });
    
    report += `\n`; // Add space between students
  });
  
  // Add class statistics
  const avgPercentage = students.length > 0 
    ? (students.reduce((sum, s) => sum + parseFloat(calculatePercentage(s.id)), 0) / students.length).toFixed(1)
    : 0;
  
  report += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
  report += `üìä CLASS STATISTICS:\n`;
  report += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
  report += `Average Percentage: ${avgPercentage}%\n`;
  report += `Highest Percentage: ${rankings[0]?.percentage || 0}%\n`;
  report += `Lowest Percentage: ${rankings[rankings.length - 1]?.percentage || 0}%\n`;
  
  // Add test-wise averages
  report += `\nüìà TEST-WISE AVERAGES:\n`;
  visibleTests.forEach(test => {
    const testStudents = students.filter(s => {
      const mark = s.marks[test.id];
      return mark && mark.obj !== 'Absent' && mark.obj !== '' && !isNaN(parseFloat(mark.obj));
    });
    
    const testAvg = testStudents.length > 0 
      ? (testStudents.reduce((sum, s) => sum + parseFloat(s.marks[test.id].obj), 0) / testStudents.length).toFixed(1)
      : 0;
    
    report += `${test.name}: ${testAvg}/${test.objMax}\n`;
  });
  
  return report;
};
      const copyIndividualReport = (student) => {
        const report = generateIndividualReport(student);
        navigator.clipboard.writeText(report);
        setDataStatus('‚úÖ Report copied to clipboard!');
        setTimeout(() => setDataStatus(''), 3000);
      };

      // NEW: Copy test report to clipboard
      const copyTestReport = (testId) => {
        const report = generateTestReport(testId);
        navigator.clipboard.writeText(report);
        setDataStatus('‚úÖ Test report copied to clipboard!');
        setTimeout(() => setDataStatus(''), 3000);
      };

      // NEW: Copy class list to clipboard
      const copyClassList = () => {
        const report = generateClassList();
        navigator.clipboard.writeText(report);
        setDataStatus('‚úÖ Class list copied to clipboard!');
        setTimeout(() => setDataStatus(''), 3000);
      };

      const exportAllStudentsReports = () => {
        students.forEach((student, index) => {
          setTimeout(() => {
            const report = generateIndividualReport(student);
            const blob = new Blob([report], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${student.name}_${subjectName}_Report.txt`;
            a.click();
          }, index * 100);
        });
        setDataStatus('‚úÖ All reports exported successfully!');
        setTimeout(() => setDataStatus(''), 3000);
      };

      // NEW: Export all test reports as text
      const exportAllTestReports = () => {
        tests.filter(t => t.completed).forEach((test, index) => {
          setTimeout(() => {
            const report = generateTestReport(test.id);
            const blob = new Blob([report], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${test.name}_${subjectName}_Report.txt`;
            a.click();
          }, index * 100);
        });
        setDataStatus('‚úÖ All test reports exported successfully!');
        setTimeout(() => setDataStatus(''), 3000);
      };

      const saveCurrentSubject = () => {
        const subjectData = {
          name: subjectName,
          className: className,
          students: students,
          tests: tests,
          gradeSystem: gradeSystem
        };
        
        const dataStr = JSON.stringify(subjectData);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${className}_${subjectName}_Data.json`;
        a.click();
        setDataStatus('‚úÖ Subject data saved successfully!');
        setTimeout(() => setDataStatus(''), 3000);
      };

      const loadSubjectData = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (event) => {
            try {
              const data = JSON.parse(event.target.result);
              setSubjectName(data.name);
              setClassName(data.className);
              setStudents(data.students);
              setTests(data.tests);
              if (data.gradeSystem) setGradeSystem(data.gradeSystem);
              setDataStatus('‚úÖ Subject data loaded successfully!');
              setTimeout(() => setDataStatus(''), 3000);
            } catch (error) {
              setDataStatus('‚ùå Error loading file');
              setTimeout(() => setDataStatus(''), 3000);
            }
          };
          reader.readAsText(file);
        }
      };

      const clearAllData = () => {
        if (confirm('Are you sure you want to clear all data? This action cannot be undone.')) {
          localStorage.removeItem('studentMarksData');
          
          setSubjectName('Computer Science');
          setClassName('Class 9');
          setStudents([
            { id: 1, name: 'Kamran', marks: { 1: { obj: 10.5, total: 40 }, 2: { obj: 11, total: 40 } } },
            { id: 2, name: 'Waqas', marks: { 1: { obj: 12, total: 40 }, 2: { obj: 9, total: 40 } } },
            { id: 3, name: 'Shahryar', marks: { 1: { obj: 9, total: 40 }, 2: { obj: 17, total: 40 } } },
            { id: 4, name: 'Mehtab', marks: { 1: { obj: 'Absent', total: 40 }, 2: { obj: 9.5, total: 40 } } },
            { id: 5, name: 'Saghar', marks: { 1: { obj: 20, total: 40 }, 2: { obj: 23, total: 40 } } },
          ]);
          setTests([
            { id: 1, name: 'Test #1', objMax: 40, totalMax: 40, date: '2025-10-01', completed: true },
            { id: 2, name: 'Test #2', objMax: 40, totalMax: 40, date: '2025-10-15', completed: true }
          ]);
          setLastSaved(null);
          setDataStatus('‚úÖ All data cleared successfully!');
          setTimeout(() => setDataStatus(''), 3000);
        }
      };

      const visibleTests = hideIncompleteTests ? tests.filter(t => t.completed) : tests;

      // Debug: Log current state
      console.log('Current students:', students);
      console.log('Current tests:', tests);

      if (selectedStudent) {
        const student = students.find(s => s.id === selectedStudent);
        if (!student) {
          setSelectedStudent(null);
          return null;
        }
        
        const rankings = getRankings();
        const rank = rankings.findIndex(s => s.id === student.id) + 1;
        const overallPerc = calculatePercentage(student.id);
        const grade = getGrade(overallPerc);
        
        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
            <div className="max-w-4xl mx-auto bg-white rounded-xl shadow-2xl p-6">
              <button
                onClick={() => setSelectedStudent(null)}
                className="mb-4 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600"
              >
                ‚Üê Back
              </button>
              
              <div className="text-center mb-6">
                <h1 className="text-3xl font-bold text-indigo-900">{className}</h1>
                <h2 className="text-xl text-indigo-700">{subjectName}</h2>
                <div className="h-1 w-32 bg-indigo-600 mx-auto rounded mt-2"></div>
              </div>
              
              <div className="bg-gradient-to-r from-indigo-500 to-purple-600 text-white p-6 rounded-lg mb-4">
                <h2 className="text-2xl font-bold mb-1">{student.name}</h2>
                <p className="text-sm">Generated: {new Date().toLocaleDateString()}</p>
              </div>
              
              <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                <div className="bg-blue-50 p-3 rounded-lg text-center">
                  <p className="text-xs text-gray-600">Overall %</p>
                  <p className="text-2xl font-bold text-blue-600">{overallPerc}%</p>
                </div>
                <div className="bg-green-50 p-3 rounded-lg text-center">
                  <p className="text-xs text-gray-600">Grade</p>
                  <p className="text-2xl font-bold text-green-600">{grade.grade}</p>
                </div>
                <div className="bg-purple-50 p-3 rounded-lg text-center">
                  <p className="text-xs text-gray-600">Rank</p>
                  <p className="text-2xl font-bold text-purple-600">{rank}/{students.length}</p>
                </div>
                <div className="bg-orange-50 p-3 rounded-lg text-center">
                  <p className="text-xs text-gray-600">Status</p>
                  <p className="text-2xl font-bold text-orange-600">{grade.remarks}</p>
                </div>
              </div>
              
              <h3 className="text-lg font-bold mb-3 text-gray-800">Test Details</h3>
              <div className="space-y-3 mb-6">
                {tests.filter(t => t.completed).map(test => {
                  const mark = student.marks[test.id] || { obj: '', total: test.totalMax };
                  const testRankings = getTestRankings(test.id);
                  const testRank = testRankings.findIndex(s => s.id === student.id) + 1;
                  const percentage = mark.obj !== 'Absent' && mark.obj !== '' && !isNaN(parseFloat(mark.obj))
                    ? ((parseFloat(mark.obj) / test.objMax) * 100).toFixed(1)
                    : 'N/A';
                  
                  return (
                    <div key={test.id} className="border-l-4 border-indigo-500 bg-gray-50 p-3 rounded-r-lg">
                      <div className="flex justify-between items-start mb-2">
                        <div>
                          <h4 className="font-bold text-gray-800">{test.name}</h4>
                          <p className="text-xs text-gray-500">{test.date}</p>
                        </div>
                        <span className="px-2 py-1 rounded-full text-sm font-bold bg-indigo-100 text-indigo-800">
                          {percentage}%
                        </span>
                      </div>
                      <div className="grid grid-cols-3 gap-2 text-sm">
                        <div>
                          <p className="text-gray-600 text-xs">Marks</p>
                          <p className="font-bold">{mark.obj === 'Absent' ? 'Absent' : `${mark.obj}/${test.totalMax}`}</p>
                        </div>
                        <div>
                          <p className="text-gray-600 text-xs">Test Rank</p>
                          <p className="font-bold">{mark.obj === 'Absent' ? 'N/A' : `${testRank}/${students.length}`}</p>
                        </div>
                        <div>
                          <p className="text-gray-600 text-xs">Status</p>
                          <p className="font-bold">{mark.obj === 'Absent' ? '‚ùå' : '‚úÖ'}</p>
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
              
              <div className="grid grid-cols-3 gap-3">
                <button
                  onClick={() => copyIndividualReport(student)}
                  className="bg-green-600 text-white py-2 rounded-lg font-bold hover:bg-green-700 flex items-center justify-center gap-2"
                >
                  <FileText size={18} />
                  Copy for WhatsApp
                </button>
                <button
                  onClick={() => exportToExcel('student')}
                  className="bg-blue-600 text-white py-2 rounded-lg font-bold hover:bg-blue-700 flex items-center justify-center gap-2"
                >
                  <Download size={18} />
                  Export Excel
                </button>
                <button
                  onClick={() => exportToPDF('student')}
                  className="bg-red-600 text-white py-2 rounded-lg font-bold hover:bg-red-700 flex items-center justify-center gap-2"
                >
                  <FilePdf size={18} />
                  Export PDF
                </button>
              </div>
            </div>
          </div>
        );
      }

      if (showSettings) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
            <div className="max-w-4xl mx-auto bg-white rounded-xl shadow-2xl p-6">
              <button
                onClick={() => setShowSettings(false)}
                className="mb-4 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600"
              >
                ‚Üê Back
              </button>
              
              <h2 className="text-2xl font-bold text-indigo-900 mb-6">‚öôÔ∏è Settings</h2>
              
              <div className="space-y-6">
                <div className="bg-blue-50 p-4 rounded-lg">
                  <h3 className="font-bold text-lg mb-3 text-gray-800">Class & Subject Information</h3>
                  <div className="space-y-3">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Class Name</label>
                      <input
                        type="text"
                        value={className}
                        onChange={(e) => setClassName(e.target.value)}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Subject Name</label>
                      <input
                        type="text"
                        value={subjectName}
                        onChange={(e) => setSubjectName(e.target.value)}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                      />
                    </div>
                  </div>
                </div>

                <div className="bg-green-50 p-4 rounded-lg">
                  <h3 className="font-bold text-lg mb-3 text-gray-800">Test Management</h3>
                  <div className="space-y-3">
                    {tests.map(test => (
                      <div key={test.id} className="bg-white p-3 rounded-lg border border-gray-200">
                        <div className="grid grid-cols-2 gap-2 mb-2">
                          <input
                            type="text"
                            value={test.name}
                            onChange={(e) => updateTest(test.id, 'name', e.target.value)}
                            className="px-2 py-1 border border-gray-300 rounded text-sm"
                            placeholder="Test Name"
                          />
                          <input
                            type="date"
                            value={test.date}
                            onChange={(e) => updateTest(test.id, 'date', e.target.value)}
                            className="px-2 py-1 border border-gray-300 rounded text-sm"
                          />
                        </div>
                        <div className="grid grid-cols-4 gap-2">
                          <div className="flex items-center gap-1">
                            <span className="text-xs text-gray-600">Max:</span>
                            <input
                              type="number"
                              value={test.objMax}
                              onChange={(e) => updateTest(test.id, 'objMax', parseInt(e.target.value))}
                              className="w-full px-2 py-1 border border-gray-300 rounded text-sm"
                              placeholder="Max Marks"
                            />
                          </div>
                          <div className="flex items-center gap-1">
                            <span className="text-xs text-gray-600">Total:</span>
                            <input
                              type="number"
                              value={test.totalMax}
                              onChange={(e) => updateTest(test.id, 'totalMax', parseInt(e.target.value))}
                              className="w-full px-2 py-1 border border-gray-300 rounded text-sm"
                              placeholder="Total Marks"
                            />
                          </div>
                          <button
                            onClick={() => toggleTestCompletion(test.id)}
                            className={`px-2 py-1 rounded text-sm font-medium ${
                              test.completed 
                                ? 'bg-green-500 text-white' 
                                : 'bg-yellow-500 text-white'
                            }`}
                          >
                            {test.completed ? '‚úì Complete' : '‚è± Pending'}
                          </button>
                          <button
                            onClick={() => deleteTest(test.id)}
                            className="px-2 py-1 bg-red-500 text-white rounded text-sm hover:bg-red-600"
                          >
                            Delete
                          </button>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>

                <div className="bg-purple-50 p-4 rounded-lg">
                  <h3 className="font-bold text-lg mb-3 text-gray-800">Grade System</h3>
                  <button
                    onClick={() => setShowGradeSettings(!showGradeSettings)}
                    className="mb-3 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700"
                  >
                    {showGradeSettings ? 'Hide' : 'Show'} Grade Settings
                  </button>
                  
                  {showGradeSettings && (
                    <div className="space-y-2">
                      {gradeSystem.map((grade, idx) => (
                        <div key={idx} className="grid grid-cols-4 gap-2 bg-white p-2 rounded">
                          <input
                            type="number"
                            value={grade.min}
                            onChange={(e) => {
                              const newGrades = [...gradeSystem];
                              newGrades[idx].min = parseInt(e.target.value);
                              setGradeSystem(newGrades);
                            }}
                            className="px-2 py-1 border border-gray-300 rounded text-sm"
                            placeholder="Min %"
                          />
                          <input
                            type="text"
                            value={grade.grade}
                            onChange={(e) => {
                              const newGrades = [...gradeSystem];
                              newGrades[idx].grade = e.target.value;
                              setGradeSystem(newGrades);
                            }}
                            className="px-2 py-1 border border-gray-300 rounded text-sm"
                            placeholder="Grade"
                          />
                          <input
                            type="text"
                            value={grade.remarks}
                            onChange={(e) => {
                              const newGrades = [...gradeSystem];
                              newGrades[idx].remarks = e.target.value;
                              setGradeSystem(newGrades);
                            }}
                            className="col-span-2 px-2 py-1 border border-gray-300 rounded text-sm"
                            placeholder="Remarks"
                          />
                        </div>
                      ))}
                    </div>
                  )}
                </div>

                <div className="bg-orange-50 p-4 rounded-lg">
                  <h3 className="font-bold text-lg mb-3 text-gray-800">Data Management</h3>
                  <div className="space-y-3">
                    <div className="flex items-center justify-between bg-white p-3 rounded-lg">
                      <div>
                        <p className="font-medium">Auto-Save</p>
                        <p className="text-sm text-gray-600">Automatically save data when changes are made</p>
                        {lastSaved && (
                          <p className="text-xs text-green-600">Last saved: {lastSaved}</p>
                        )}
                      </div>
                      <button
                        onClick={() => setAutoSaveEnabled(!autoSaveEnabled)}
                        className={`px-4 py-2 rounded-lg font-medium ${
                          autoSaveEnabled 
                            ? 'bg-green-600 text-white' 
                            : 'bg-gray-300 text-gray-700'
                        }`}
                      >
                        {autoSaveEnabled ? 'Enabled' : 'Disabled'}
                      </button>
                    </div>
                    
                    <div className="grid grid-cols-2 gap-3">
                      <button
                        onClick={saveCurrentSubject}
                        className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2"
                      >
                        <Download size={18} />
                        Save Subject Data
                      </button>
                      <label className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center justify-center gap-2 cursor-pointer">
                        <Upload size={18} />
                        Load Subject Data
                        <input
                          type="file"
                          accept=".json"
                          onChange={loadSubjectData}
                          className="hidden"
                        />
                      </label>
                    </div>
                    <div className="grid grid-cols-2 gap-3">
                      <button
                        onClick={() => exportToExcel('all')}
                        className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 flex items-center justify-center gap-2"
                      >
                        <Spreadsheet size={18} />
                        Export Excel
                      </button>
                      <label className="px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700 flex items-center justify-center gap-2 cursor-pointer">
                        <Upload size={18} />
                        Import Excel
                        <input
                          type="file"
                          accept=".xlsx,.xls"
                          onChange={importFromExcel}
                          className="hidden"
                        />
                      </label>
                    </div>
                    <button
                      onClick={clearAllData}
                      className="w-full px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 flex items-center justify-center gap-2"
                    >
                      <Trash2 size={18} />
                      Clear All Data
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
          <div className="max-w-7xl mx-auto">
            {/* Status Message */}
            {dataStatus && (
              <div className={`fixed top-4 right-4 px-4 py-2 rounded-lg shadow-lg z-50 ${
                dataStatus.includes('‚úÖ') ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
              }`}>
                {dataStatus}
              </div>
            )}

            <div className="bg-white rounded-xl shadow-2xl p-6 mb-6">
              <div className="flex justify-between items-center mb-4">
                <div>
                  <div className="flex items-center gap-3 mb-2">
                    {editingClassName ? (
                      <input
                        type="text"
                        value={className}
                        onChange={(e) => setClassName(e.target.value)}
                        className="text-3xl font-bold text-indigo-900 bg-blue-50 px-3 py-1 rounded border border-indigo-200"
                        onBlur={() => setEditingClassName(false)}
                        onKeyPress={(e) => e.key === 'Enter' && setEditingClassName(false)}
                        autoFocus
                      />
                    ) : (
                      <h1 
                        className="text-3xl font-bold text-indigo-900 cursor-pointer hover:bg-blue-50 px-3 py-1 rounded"
                        onClick={() => setEditingClassName(true)}
                      >
                        {className}
                      </h1>
                    )}
                    <span className="text-3xl font-bold text-gray-400">-</span>
                    {editingSubject ? (
                      <input
                        type="text"
                        value={subjectName}
                        onChange={(e) => setSubjectName(e.target.value)}
                        className="text-3xl font-bold text-indigo-900 bg-blue-50 px-3 py-1 rounded border border-indigo-200"
                        onBlur={() => setEditingSubject(false)}
                        onKeyPress={(e) => e.key === 'Enter' && setEditingSubject(false)}
                        autoFocus
                      />
                    ) : (
                      <h1 
                        className="text-3xl font-bold text-indigo-900 cursor-pointer hover:bg-blue-50 px-3 py-1 rounded"
                        onClick={() => setEditingSubject(true)}
                      >
                        {subjectName}
                      </h1>
                    )}
                  </div>
                  <p className="text-gray-600">Dynamic Marks Management System</p>
                  {autoSaveEnabled && lastSaved && (
                    <p className="text-xs text-green-600 mt-1">
                      ‚úÖ Auto-save enabled ‚Ä¢ Last saved: {lastSaved}
                    </p>
                  )}
                </div>
                <div className="flex gap-2">
                  <button
                    onClick={() => setShowSettings(true)}
                    className="flex items-center gap-2 bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700"
                  >
                    <Settings size={20} />
                    Settings
                  </button>
                  <button
                    onClick={() => setHideIncompleteTests(!hideIncompleteTests)}
                    className="flex items-center gap-2 bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700"
                  >
                    {hideIncompleteTests ? <Eye size={20} /> : <EyeOff size={20} />}
                    {hideIncompleteTests ? 'Show All' : 'Hide Pending'}
                  </button>
                </div>
              </div>
              
              <div className="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
                <div className="flex gap-2">
                  <input
                    type="text"
                    placeholder="Add student..."
                    value={newStudent}
                    onKeyPress={(e) => e.key === 'Enter' && addStudent()}
                    onChange={(e) => setNewStudent(e.target.value)}
                    className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                  />
                  <button
                    onClick={addStudent}
                    className="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 flex items-center gap-2"
                  >
                    <Plus size={20} />
                    Add
                  </button>
                </div>
                
                <button
                  onClick={addTest}
                  className="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 flex items-center justify-center gap-2"
                >
                  <Plus size={20} />
                  Add Test
                </button>

                <button
                  onClick={exportAllStudentsReports}
                  className="bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 flex items-center justify-center gap-2"
                >
                  <FileText size={20} />
                  Export All Reports
                </button>
              </div>

              <div className="flex gap-2 mb-4">
                <button
                  onClick={() => exportToExcel('all')}
                  className="flex-1 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 flex items-center justify-center gap-2"
                >
                  <Download size={20} />
                  Export Class Excel
                </button>
                <button
                  onClick={() => exportToPDF('all')}
                  className="flex-1 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 flex items-center justify-center gap-2"
                >
                  <FilePdf size={20} />
                  Export Class PDF
                </button>
                <label className="flex-1 bg-teal-600 text-white px-4 py-2 rounded-lg hover:bg-teal-700 flex items-center justify-center gap-2 cursor-pointer">
                  <Upload size={20} />
                  Import Excel
                  <input
                    type="file"
                    accept=".xlsx,.xls"
                    onChange={importFromExcel}
                    className="hidden"
                  />
                </label>
              </div>

              {/* NEW: Additional export options */}
              <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                <button
                  onClick={exportAllTestPDFs}
                  className="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 flex items-center justify-center gap-2 text-sm"
                >
                  <FilePdf size={18} />
                  All Test PDFs
                </button>
                <button
                  onClick={exportAllTestReports}
                  className="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 flex items-center justify-center gap-2 text-sm"
                >
                  <FileText size={18} />
                  All Test TXTs
                </button>
                <button
                  onClick={copyClassList}
                  className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2 text-sm"
                >
                  <FileText size={18} />
                  Copy Class List
                </button>
                <button
                  onClick={() => {
                    const report = generateClassList();
                    const blob = new Blob([report], { type: 'text/plain' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${className}_${subjectName}_ClassList.txt`;
                    a.click();
                  }}
                  className="bg-cyan-600 text-white px-4 py-2 rounded-lg hover:bg-cyan-700 flex items-center justify-center gap-2 text-sm"
                >
                  <Download size={18} />
                  Export Class List
                </button>
              </div>
            </div>

            <div className="bg-white rounded-xl shadow-2xl overflow-hidden mb-6">
              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead>
                    <tr className="bg-gradient-to-r from-indigo-600 to-purple-600 text-white">
                      <th className="px-4 py-3 text-left font-bold sticky left-0 bg-indigo-600 z-10">Student</th>
                      {visibleTests.map(test => (
                        <th key={test.id} className="px-4 py-3 text-center border-l border-indigo-400" colSpan="2">
                          <div className="flex flex-col items-center">
                            <span className="font-bold">{test.name}</span>
                            <span className="text-xs">{test.date}</span>
                            {!test.completed && <span className="text-xs bg-yellow-500 px-2 py-0.5 rounded mt-1">Pending</span>}
                            <div className="flex items-center gap-1 mt-1">
                              <span className="text-xs">Total:</span>
                              {editingTestTotal === test.id ? (
                                <input
                                  type="number"
                                  value={test.totalMax}
                                  onChange={(e) => updateTest(test.id, 'totalMax', parseInt(e.target.value))}
                                  className="w-12 px-1 py-0.5 text-xs border border-gray-300 rounded text-black"
                                  onBlur={() => setEditingTestTotal(null)}
                                  onKeyPress={(e) => e.key === 'Enter' && setEditingTestTotal(null)}
                                  autoFocus
                                />
                              ) : (
                                <span 
                                  className="text-xs cursor-pointer hover:bg-indigo-700 px-1 py-0.5 rounded"
                                  onClick={() => setEditingTestTotal(test.id)}
                                >
                                  {test.totalMax}
                                </span>
                              )}
                            </div>
                            {/* NEW: Test-specific export buttons */}
                            {test.completed && (
                              <div className="flex gap-1 mt-1">
                                <button
                                  onClick={() => copyTestReport(test.id)}
                                  className="text-xs bg-green-600 hover:bg-green-700 px-1 py-0.5 rounded"
                                  title="Copy test report"
                                >
                                  Copy
                                </button>
                                <button
                                  onClick={() => exportToPDF('test', test.id)}
                                  className="text-xs bg-red-600 hover:bg-red-700 px-1 py-0.5 rounded"
                                  title="Export test PDF"
                                >
                                  PDF
                                </button>
                              </div>
                            )}
                          </div>
                        </th>
                      ))}
                      <th className="px-4 py-3 text-center border-l border-indigo-400">%</th>
                      <th className="px-4 py-3 text-center border-l border-indigo-400">Grade</th>
                      <th className="px-4 py-3 text-center border-l border-indigo-400">Rank</th>
                      <th className="px-4 py-3 text-center border-l border-indigo-400">Actions</th>
                    </tr>
                    <tr className="bg-indigo-500 text-white text-sm">
                      <th className="px-4 py-2 sticky left-0 bg-indigo-500 z-10"></th>
                      {visibleTests.map(test => (
                        <React.Fragment key={test.id}>
                          <th className="px-2 py-2 border-l border-indigo-400">Obtained</th>
                          <th className="px-2 py-2">Total</th>
                        </React.Fragment>
                      ))}
                      <th className="px-4 py-2 border-l border-indigo-400"></th>
                      <th className="px-4 py-2 border-l border-indigo-400"></th>
                      <th className="px-4 py-2 border-l border-indigo-400"></th>
                      <th className="px-4 py-2 border-l border-indigo-400"></th>
                    </tr>
                  </thead>
                  <tbody>
                    {getRankings().map((student, idx) => {
                      const overallPerc = calculatePercentage(student.id);
                      const grade = getGrade(overallPerc);
                      const rank = idx + 1;
                      
                      return (
                        <tr key={student.id} className={`border-b ${idx % 2 === 0 ? 'bg-gray-50' : 'bg-white'} hover:bg-blue-50`}>
                          <td className="px-4 py-3 font-medium sticky left-0 bg-inherit z-10">
                            <div className="flex items-center justify-between">
                              <input
                                type="text"
                                value={student.name}
                                onChange={(e) => updateStudentName(student.id, e.target.value)}
                                className="bg-transparent border-b border-dashed border-gray-300 focus:border-indigo-500 focus:outline-none px-1"
                              />
                              <button
                                onClick={() => deleteStudent(student.id)}
                                className="ml-2 p-1 text-red-600 hover:bg-red-100 rounded"
                              >
                                <Trash2 size={16} />
                              </button>
                            </div>
                          </td>
                          {visibleTests.map(test => {
                            const mark = student.marks[test.id] || { obj: '', total: test.totalMax };
                            return (
                              <React.Fragment key={test.id}>
                                <td className="px-2 py-2 border-l border-gray-200">
                                  <input
                                    type="text"
                                    value={mark.obj}
                                    onChange={(e) => updateMarks(student.id, test.id, 'obj', e.target.value)}
                                    className="w-full px-2 py-1 text-center border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500"
                                    placeholder="0"
                                  />
                                </td>
                                <td className="px-2 py-2 text-center text-gray-600">
                                  <input
                                    type="number"
                                    value={mark.total}
                                    onChange={(e) => updateMarks(student.id, test.id, 'total', parseInt(e.target.value))}
                                    className="w-16 px-2 py-1 text-center border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500"
                                  />
                                </td>
                              </React.Fragment>
                            );
                          })}
                          <td className="px-4 py-3 text-center font-bold border-l border-gray-200">
                            <span className={`px-3 py-1 rounded-full text-sm ${
                              overallPerc >= 80 ? 'bg-green-100 text-green-800' :
                              overallPerc >= 60 ? 'bg-blue-100 text-blue-800' :
                              overallPerc >= 40 ? 'bg-yellow-100 text-yellow-800' :
                              'bg-red-100 text-red-800'
                            }`}>
                              {overallPerc}%
                            </span>
                          </td>
                          <td className="px-4 py-3 text-center font-bold border-l border-gray-200">
                            <span className="text-lg">{grade.grade}</span>
                          </td>
                          <td className="px-4 py-3 text-center font-bold border-l border-gray-200">
                            <span className="flex items-center justify-center gap-1">
                              {rank === 1 && <Award className="text-yellow-500" size={18} />}
                              {rank === 2 && <Award className="text-gray-400" size={18} />}
                              {rank === 3 && <Award className="text-orange-500" size={18} />}
                              {rank}
                            </span>
                          </td>
                          <td className="px-4 py-3 text-center border-l border-gray-200">
                            <button
                              onClick={() => setSelectedStudent(student.id)}
                              className="px-3 py-1 bg-indigo-600 text-white rounded hover:bg-indigo-700 text-sm"
                            >
                              View Report
                            </button>
                          </td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
            </div>

            <div className="bg-white rounded-xl shadow-xl p-6">
              <h3 className="text-xl font-bold text-gray-800 mb-4">üìä Class Statistics</h3>
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div className="bg-blue-50 p-4 rounded-lg text-center">
                  <p className="text-sm text-gray-600">Total Students</p>
                  <p className="text-3xl font-bold text-blue-600">{students.length}</p>
                </div>
                <div className="bg-green-50 p-4 rounded-lg text-center">
                  <p className="text-sm text-gray-600">Total Tests</p>
                  <p className="text-3xl font-bold text-green-600">{tests.length}</p>
                </div>
                <div className="bg-purple-50 p-4 rounded-lg text-center">
                  <p className="text-sm text-gray-600">Completed Tests</p>
                  <p className="text-3xl font-bold text-purple-600">{tests.filter(t => t.completed).length}</p>
                </div>
                <div className="bg-orange-50 p-4 rounded-lg text-center">
                  <p className="text-sm text-gray-600">Avg. Class %</p>
                  <p className="text-3xl font-bold text-orange-600">
                    {students.length > 0 
                      ? (students.reduce((sum, s) => sum + parseFloat(calculatePercentage(s.id)), 0) / students.length).toFixed(1)
                      : 0}%
                  </p>
                </div>
              </div>

              <div className="mt-6">
                <h4 className="font-bold text-gray-800 mb-3">üèÜ Top 5 Students</h4>
                <div className="space-y-2">
                  {getRankings().slice(0, 5).map((student, idx) => {
                    const grade = getGrade(calculatePercentage(student.id));
                    return (
                      <div key={student.id} className="flex items-center justify-between bg-gray-50 p-3 rounded-lg">
                        <div className="flex items-center gap-3">
                          <span className="text-2xl font-bold text-gray-400">#{idx + 1}</span>
                          {idx === 0 && <Award className="text-yellow-500" size={24} />}
                          {idx === 1 && <Award className="text-gray-400" size={24} />}
                          {idx === 2 && <Award className="text-orange-500" size={24} />}
                          <span className="font-medium">{student.name}</span>
                        </div>
                        <div className="flex items-center gap-3">
                          <span className="font-bold text-indigo-600">{student.percentage}%</span>
                          <span className="px-3 py-1 bg-indigo-100 text-indigo-800 rounded-full font-bold">
                            {grade.grade}
                          </span>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            </div>

            <div className="mt-6 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-xl p-6 text-center">
              <h3 className="text-xl font-bold mb-2">üì± Ready to Share Results?</h3>
              <p className="mb-4">Export individual reports for WhatsApp or generate complete class Excel sheet</p>
              <div className="flex gap-3 justify-center flex-wrap">
                <button
                  onClick={exportAllStudentsReports}
                  className="bg-white text-indigo-600 px-6 py-2 rounded-lg font-bold hover:bg-gray-100 flex items-center gap-2"
                >
                  <FileText size={20} />
                  Download All Reports (TXT)
                </button>
                <button
                  onClick={() => exportToExcel('all')}
                  className="bg-white text-indigo-600 px-6 py-2 rounded-lg font-bold hover:bg-gray-100 flex items-center gap-2"
                >
                  <Download size={20} />
                  Download Class Excel
                </button>
                <button
                  onClick={() => exportToPDF('all')}
                  className="bg-white text-indigo-600 px-6 py-2 rounded-lg font-bold hover:bg-gray-100 flex items-center gap-2"
                >
                  <FilePdf size={20} />
                  Download Class PDF
                </button>
                <label className="bg-white text-indigo-600 px-6 py-2 rounded-lg font-bold hover:bg-gray-100 flex items-center gap-2 cursor-pointer">
                  <Upload size={20} />
                  Import Excel
                  <input
                    type="file"
                    accept=".xlsx,.xls"
                    onChange={importFromExcel}
                    className="hidden"
                  />
                </label>
              </div>

              {/* NEW: Additional export options */}
              <div className="flex gap-3 justify-center flex-wrap mt-4">
                <button
                  onClick={exportAllTestPDFs}
                  className="bg-white text-indigo-600 px-6 py-2 rounded-lg font-bold hover:bg-gray-100 flex items-center gap-2"
                >
                  <FilePdf size={20} />
                  All Test PDFs
                </button>
                <button
                  onClick={exportAllTestReports}
                  className="bg-white text-indigo-600 px-6 py-2 rounded-lg font-bold hover:bg-gray-100 flex items-center gap-2"
                >
                  <FileText size={20} />
                  All Test TXTs
                </button>
                <button
                  onClick={copyClassList}
                  className="bg-white text-indigo-600 px-6 py-2 rounded-lg font-bold hover:bg-gray-100 flex items-center gap-2"
                >
                  <FileText size={20} />
                  Copy Class List
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    };

    ReactDOM.render(<StudentMarksTracker />, document.getElementById('root'));
  </script>
</body>
</html>
